<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>用地功能排布两两对比问卷（四组×每组2题）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .hidden { display:none; }
    .fade-in { animation: fadeIn .25s ease-in; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }

    .admin-panel { position: fixed; bottom: 10px; left: 10px; z-index: 9999; pointer-events:auto; }
    .admin-panel button{
      background:#1f2937; color:#fff; padding:6px 12px; border-radius:6px; font-size:12px; border:none;
      cursor:pointer; transition:background-color .2s; box-shadow:0 2px 6px rgba(0,0,0,.12);
    }
    .admin-panel button:hover{ background:#374151; }

    .loading-indicator{ display:inline-flex; align-items:center; gap:8px; }
    .spinner{ width:16px; height:16px; border:2px solid #e5e7eb; border-top:2px solid #3b82f6; border-radius:50%; animation:spin 1s linear infinite;}
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    .status-indicator{ padding:10px 12px; border-radius:10px; font-size:14px; display:flex; align-items:center; gap:10px; margin-bottom:14px;}
    .status-success{ background:#d1fae5; color:#065f46;}
    .status-error{ background:#fee2e2; color:#991b1b;}
    .status-warning{ background:#fef3c7; color:#92400e;}

    .img-box{
      width: 520px; height: 390px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      display:flex; align-items:center; justify-content:center;
    }
    .survey-image{
      width:100%; height:100%;
      object-fit: contain;
      background:#f8fafc;
    }

    .progress-bar{ height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .progress-fill{ height:100%; background:#10b981; width:0%; transition:width .2s ease; }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      background: #f8fafc;
      color: #334155;
    }

    .countdown-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      background:#fff7ed; border:1px solid #fdba74; color:#9a3412;
      font-size:13px; font-weight:600;
    }

    .btn-disabled{
      background:#9ca3af !important;
      cursor:not-allowed !important;
      pointer-events:none !important;
      opacity:.9;
    }
  </style>
</head>

<body class="bg-gray-100">

  <!-- 顶部数据状态 -->
  <div id="dataStatusIndicator" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 hidden">
    <div class="status-indicator status-warning">
      <div class="spinner"></div>
      <span id="dataStatusText">正在保存数据...</span>
    </div>
  </div>

  <!-- 语言选择页 -->
  <div id="languagePage" class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
    <!-- 管理员入口 -->
    <div class="admin-panel">
      <button onclick="showAdminPanel()">管理员</button>
    </div>

    <div class="bg-white rounded-xl shadow-lg p-8 text-center max-w-md w-full">
      <h1 class="text-2xl font-bold text-gray-800 mb-2">用地功能排布两两对比问卷</h1>
      <p class="text-gray-600 mb-8">Pairwise Comparison Survey</p>

      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">语言选择</h3>
        <p class="text-sm text-gray-500">Select Language</p>
      </div>

      <div class="flex justify-center space-x-4">
        <button onclick="selectLanguage('zh')" class="px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-medium">中文</button>
        <button onclick="selectLanguage('en')" class="px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-medium">English</button>
      </div>
    </div>
  </div>

  <!-- 基础信息页 -->
  <div id="surveyPage" class="hidden min-h-screen bg-gray-100 p-4">
    <div class="max-w-3xl mx-auto">
      <h1 id="surveyTitle" class="text-2xl font-bold text-center text-gray-800 mb-8">两两对比实验</h1>

      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6">
          <h3 id="introTitle" class="font-semibold text-amber-900 mb-2">实验说明</h3>
          <div id="introText" class="text-amber-900 text-sm leading-6">
            <p class="mb-2">欢迎参加香港科技大学（广州）UMS智能规划实验</p>
            <p class="mb-2">本实验采用 <b>两两对比</b> 的形式，共分 <b>四组</b>。</p>
            <p class="mb-2">每位被试需要完成 <b>8 道题</b>：每组对比做 <b>2 道</b>。</p>
            <p class="mb-2">实验将记录您的选择和决策时间，不涉及个人隐私。实验数据将用于科学研究，输入昵称点击"开始实验"视为同意参与实验。</p>
            <p class="mb-2">请聚焦 <b>30万人口级独立大型社区</b> 的用地功能排布，不考虑地块与路网形态更改可能性，从以下三方面选择更优方案：</p>
            <ol class="list-decimal pl-5">
              <li><b>功能配比与人口需求的匹配度</b></li>
              <li><b>服务设施的空间覆盖与可达性水平</b></li>
              <li><b>功能团块的集聚性、分隔度及整体结构合理性</b></li>
            </ol>
          </div>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-gray-700 font-medium mb-2">
              <span id="nicknameLabel">您的昵称：</span> <span class="text-red-500">*</span>
            </label>
            <input type="text" id="nicknameInput"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                   placeholder="请输入一个用于识别的昵称">
            <p id="nicknameHint" class="text-xs text-gray-500 mt-1">用于识别本次作答。</p>
          </div>
        </div>

        <div class="mt-8 text-right">
          <button onclick="startExperiment()"
                  id="startButton"
                  class="px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-medium">
            <span id="startButtonText">开始实验</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 对比页 -->
  <div id="comparePage" class="hidden min-h-screen bg-gray-100 p-4">
    <div class="max-w-6xl mx-auto">

      <!-- 进度 + 倒计时 -->
      <div class="bg-white rounded-xl shadow p-5 mb-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <div class="text-lg font-semibold text-gray-800" id="progressTitle">实验进度</div>
            <div class="text-sm text-gray-600" id="progressText">已完成 0 / 8</div>
            <div class="text-xs text-gray-500 mt-1" id="groupProgressText">当前组：-（本组 0 / 2）</div>
            <div class="text-xs text-gray-500 mt-1" id="phaseText">当前阶段：-</div>
          </div>
          <div class="w-full md:w-72">
            <div class="progress-bar">
              <div id="progressFill" class="progress-fill"></div>
            </div>
            <div class="mt-3 flex justify-end">
              <div id="countdownPill" class="countdown-pill">
                <span id="countdownLabel">请思考</span>
                <span class="kbd" id="countdownValue">15</span>
                <span id="countdownSuffix">秒后可选择</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 指导语 -->
      <div class="bg-white rounded-xl shadow p-5 mb-5">
        <h3 class="font-semibold text-gray-800 mb-2" id="compareHintTitle">请选择更优方案</h3>
        <div class="text-sm text-gray-600 leading-6" id="compareHintText">
          请聚焦30万人口级独立大型社区的用地功能排布，不考虑地块与路网形态的更改可能性，从以下三方面选择更优方案：<br>
          1) <b>功能配比与人口需求的匹配度</b>；
          2) <b>服务设施的空间覆盖与可达性水平</b>；
          3) <b>功能团块的集聚性、分隔度及整体结构合理性</b>。
        </div>
      </div>

      <!-- 两图对比 -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-6">
        <div class="bg-white rounded-xl shadow p-5">
          <div class="flex items-center justify-between mb-3">
            <div class="font-semibold text-gray-800" id="leftLabel">左图（image1）</div>
            <div class="text-xs text-gray-500" id="leftName">-</div>
          </div>
          <div class="img-box mx-auto">
            <img id="leftImg" class="survey-image" alt="left">
          </div>
          <div class="mt-4">
            <button id="leftBtn" onclick="choose(0)"
              class="w-full py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-semibold">
              左图更优
            </button>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow p-5">
          <div class="flex items-center justify-between mb-3">
            <div class="font-semibold text-gray-800" id="rightLabel">右图（image2）</div>
            <div class="text-xs text-gray-500" id="rightName">-</div>
          </div>
          <div class="img-box mx-auto">
            <img id="rightImg" class="survey-image" alt="right">
          </div>
          <div class="mt-4">
            <button id="rightBtn" onclick="choose(1)"
              class="w-full py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-semibold">
              右图更优
            </button>
          </div>
        </div>
      </div>

      <div class="text-center text-xs text-gray-500">
        <span id="trialMeta">题目：-</span>
      </div>
    </div>
  </div>

  <!-- 完成页 -->
  <div id="thankYouPage" class="hidden min-h-screen bg-gray-100 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-lg p-8 text-center max-w-md w-full">
      <div class="bg-emerald-50 border border-emerald-200 rounded-xl p-4 mb-5">
        <div class="text-sm text-emerald-900" id="finishNick">用户：-</div>
        <div class="text-xs text-emerald-800 mt-1" id="finishTip">数据已保存，感谢参与！</div>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 mb-3" id="finishTitle">实验完成</h2>
      <p class="text-gray-600 mb-6" id="finishText">您已完成 8 道对比题，数据已提交。感谢您的参与！</p>
      <button onclick="restart()" class="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors font-medium" id="restartButton">
        重新开始
      </button>
    </div>
  </div>

  <!-- 管理员界面 -->
  <div id="adminPanel" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-lg max-w-6xl w-full max-h-full overflow-auto">
      <div class="p-6 border-b">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-800">管理员面板（仅显示本次两两对比数据）</h2>
          <button onclick="hideAdminPanel()" class="text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>

      <div class="p-6">
        <div id="databaseStatus" class="mb-5">
          <div class="loading-indicator"><div class="spinner"></div><span>正在连接服务器...</span></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-5">
          <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
            <div class="font-semibold text-blue-900">参与人数（去重昵称）</div>
            <div id="totalUsers" class="text-3xl font-bold text-blue-700">-</div>
          </div>
          <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-200">
            <div class="font-semibold text-emerald-900">总记录条数</div>
            <div id="totalRecords" class="text-3xl font-bold text-emerald-700">-</div>
          </div>
          <div class="bg-purple-50 p-4 rounded-xl border border-purple-200">
            <div class="font-semibold text-purple-900">平均每人完成题数 / 8</div>
            <div id="avgPerUser" class="text-3xl font-bold text-purple-700">-</div>
          </div>
        </div>

        <div class="flex flex-wrap gap-3 mb-6">
          <button onclick="exportData()" id="exportButton" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400" disabled>导出CSV</button>
          <button onclick="clearData()" id="clearButton" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-400" disabled>清空数据</button>
          <button onclick="refreshStats()" id="refreshButton" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">刷新统计</button>
        </div>

        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-3">按组查看（gen30 → gen60 → gen90 → solution）</h3>
          <div id="groupedTables" class="space-y-6">
            <div class="text-gray-500">加载中...</div>
          </div>
        </div>

        <div>
          <h3 class="text-lg font-semibold mb-3">最近30条记录</h3>
          <div id="recentTable" class="overflow-auto max-h-80">
            <div class="text-gray-500">加载中...</div>
          </div>
        </div>
      </div>
    </div>
  </div>


<script>
/** =========================
 *  本次两两对比：配置
 *  ========================= */
const SCHEMA_VERSION = 'pairwise_v2';
const TOTAL_TRIALS = 8;
const TRIALS_PER_GROUP = 2;
const DECISION_LOCK_SECONDS = 15;

const GROUPS = [
  {
    key: 'gen30',
    left: [
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442471/gen30_Q_front_idx8_hczltv.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442471/gen30_Q_front_idx9_vzol8h.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442471/gen30_Q_front_idx7_mzpqlv.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442470/gen30_Q_front_idx5_mbleiq.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442470/gen30_Q_front_idx6_ofzecq.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442470/gen30_Q_front_idx10_j4vti4.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442470/gen30_Q_front_idx14_fyl5lk.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442470/gen30_Q_front_idx2_uq0n1b.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442469/gen30_Q_front_idx0_v6js76.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442469/gen30_Q_front_idx12_ylcrje.png'
    ],
    right: [
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442480/gen30_Y_front_idx4_aostjw.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442479/gen30_Y_front_idx3_inc8vl.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442479/gen30_Y_front_idx19_epshvq.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442478/gen30_Y_front_idx18_awwma8.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442477/gen30_Y_front_idx17_kwexz9.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442476/gen30_Y_front_idx16_ta3md6.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442476/gen30_Y_front_idx15_gwt24c.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442475/gen30_Y_front_idx13_nn5bom.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442475/gen30_Y_front_idx11_fcxkek.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442474/gen30_Y_front_idx1_ncncd6.png'
    ]
  },
  {
    key: 'gen60',
    left: [
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442488/gen60_Q_front_idx9_ajnlsv.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442487/gen60_Q_front_idx8_eviksn.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442487/gen60_Q_front_idx5_p98dft.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442485/gen60_Q_front_idx4_q9kbuc.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442485/gen60_Q_front_idx2_z6flvt.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442484/gen60_Q_front_idx19_xnmfkm.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442484/gen60_Q_front_idx17_xdi7jj.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442482/gen60_Q_front_idx13_yb3dsc.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442481/gen60_Q_front_idx1_dpc2jb.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442482/gen60_Q_front_idx12_ycauxa.png'
    ],
    right: [
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442496/gen60_Y_front_idx7_chqzqd.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442495/gen60_Y_front_idx3_jen2dl.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442495/gen60_Y_front_idx6_gwb8if.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442494/gen60_Y_front_idx18_kaaqwi.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442494/gen60_Y_front_idx16_rs3v65.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442492/gen60_Y_front_idx15_b7vnpl.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442491/gen60_Y_front_idx14_umqssc.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442491/gen60_Y_front_idx11_omgga6.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442490/gen60_Y_front_idx10_qazmzt.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442489/gen60_Y_front_idx0_ek89xs.png'
    ]
  },
  {
    key: 'gen90',
    left: [
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442508/gen90_Q_front_idx9_nwrzsy.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442506/gen90_Q_front_idx8_fdnuvd.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442504/gen90_Q_front_idx19_pzv2rl.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442505/gen90_Q_front_idx3_yy9agz.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442504/gen90_Q_front_idx16_mmvrwl.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442502/gen90_Q_front_idx15_ug53vg.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442500/gen90_Q_front_idx10_jpgqqz.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442500/gen90_Q_front_idx13_dsp16m.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442499/gen90_Q_front_idx1_qem2ml.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442499/gen90_Q_front_idx0_iurqqx.png'
    ],
    right: [
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442518/gen90_Y_front_idx7_qu0rcn.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442517/gen90_Y_front_idx6_e6u6l6.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442517/gen90_Y_front_idx5_hcloph.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442516/gen90_Y_front_idx4_ycqb7b.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442514/gen90_Y_front_idx2_tmpc0h.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442512/gen90_Y_front_idx18_gv357m.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442511/gen90_Y_front_idx17_crmnaa.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442511/gen90_Y_front_idx14_dua0k5.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442510/gen90_Y_front_idx12_yg1e8u.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442509/gen90_Y_front_idx11_o6vknf.png'
    ]
  },
  {
    key: 'solution',
    left: [
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442530/solution_A_50_iuxiwt.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442529/solution_A_44_xkhdqk.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442529/solution_A_5_q6wepq.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442527/solution_A_34_qma4p3.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442526/solution_A_26_gjaeoj.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442524/solution_A_25_u0vqsf.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442523/solution_A_24_rwsla6.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442522/solution_A_23_j7errl.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442521/solution_A_2_duxgmk.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442519/solution_A_16_jad1a4.png'
    ],
    right: [
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442541/solution_B_82_kx7saz.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442541/solution_B_83_xpnzxo.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442539/solution_B_77_y9bzwk.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442539/solution_B_80_x9w59v.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442537/solution_B_73_mn2lh1.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442536/solution_B_71_oqo47u.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442535/solution_B_65_wif5xg.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442534/solution_B_48_wtmrui.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442533/solution_B_37_vyg0zf.png',
      'https://res.cloudinary.com/dw3huanrk/image/upload/v1769442532/solution_B_110_uhpkzd.png'
    ]
  }
];

/** =========================
 *  多 Bin 配置与管理器（保持）
 *  ========================= */
const MULTI_BIN_CONFIG = {
  masterKey: '$2a$10$BBcDpoJ9fYY0c3xkth3aM.UsL3kMY1SjrqgnbeaxjWNXH4Uwqz5H.',
  baseUrl: 'https://api.jsonbin.io/v3/b',
  masterBinId: '68af17fed0ea881f40683b2d',
  allKnownBinIds: [
    '68af17fed0ea881f40683b2d','68c3b73b43b1c97be9402194','68c3b716d0ea881f407b1148','68c3faf6ae596e708fec2702',
    '68c3b5de43b1c97be940205f','68c3b57a43b1c97be940201f','68c3b55ed0ea881f407b0fee','68c3b49e43b1c97be9401f5b',
    '68c3a413ae596e708febce80','68c3a29a43b1c97be9401146','68c3a27043b1c97be94010fb','68c3a249d0ea881f407b009e',
    '68c3a24843b1c97be94010bb','68c3a22aae596e708febcc7f','68c3a1d8d0ea881f407affdd','68c3a1b0d0ea881f407affb9',
    '68c3a1a2d0ea881f407affa9','68c3a19aae596e708febcbb6','68c3a194d0ea881f407aff97','68c3a173d0ea881f407aff79',
    '68c3a123ae596e708febcb61','68c3a0fdae596e708febcb46','68c12b8ad0ea881f407861bd'
  ],
  maxBinSize: 800*1024,
  headers: {'Content-Type':'application/json','X-Master-Key':'$2a$10$BBcDpoJ9fYY0c3xkth3aM.UsL3kMY1SjrqgnbeaxjWNXH4Uwqz5H.'}
};

class MultiBinManager {
  constructor(config){ this.config=config; this.currentBinInfo=null; this.allBins=[]; }
  getDataSize(data){ return new Blob([JSON.stringify(data)]).size; }
  async scanAllKnownBins(){
    const all=[];
    for(const binId of this.config.allKnownBinIds){
      if(binId===this.config.masterBinId) continue;
      try{
        const data=await this.readDataBin(binId);
        const size=this.getDataSize(data);
        all.push({
          binId,
          createdAt:data.binInfo?.createdAt||'未知',
          recordCount:(data.sessions?.length||0)+(data.comparisons?.length||0),
          estimatedSize:size,
          status:size<this.config.maxBinSize*0.9?'available':'full',
          sessionsCount:data.sessions?.length||0,
          comparisonsCount:data.comparisons?.length||0,
          lastUpdated:data.lastUpdated||'未知'
        });
      }catch(err){
        all.push({
          binId, createdAt:'未知', recordCount:0, estimatedSize:0, status:'error',
          sessionsCount:0, comparisonsCount:0, lastUpdated:'未知', error:err.message
        });
      }
    }
    all.sort((a,b)=>{
      if(a.status==='error' && b.status!=='error') return 1;
      if(a.status!=='error' && b.status==='error') return -1;
      if(a.status==='available' && b.status!=='available') return -1;
      if(a.status!=='available' && b.status==='available') return 1;
      return a.estimatedSize - b.estimatedSize;
    });
    return all;
  }
  selectBestAvailableBin(newSize){
    const avail=this.allBins.filter(b=>b.status==='available' && b.estimatedSize+newSize<this.config.maxBinSize);
    if(avail.length===0){
      const fb=this.allBins.filter(b=>b.status!=='error');
      return fb.length>0?fb[0]:this.allBins[0];
    }
    return avail.reduce((best,c)=> c.estimatedSize<best.estimatedSize?c:best);
  }
  async readDataBin(binId){
    const r=await fetch(`${this.config.baseUrl}/${binId}/latest`,{method:'GET',headers:this.config.headers});
    if(!r.ok) throw new Error(`读取数据bin失败:${r.status}`);
    const j=await r.json(); return j.record;
  }
  async updateDataBin(binId,data){
    const r=await fetch(`${this.config.baseUrl}/${binId}`,{method:'PUT',headers:this.config.headers,body:JSON.stringify(data)});
    if(!r.ok) throw new Error(`更新数据bin失败:${r.status}`);
    return await r.json();
  }
  async initialize(){
    this.allBins=await this.scanAllKnownBins();
    if(this.allBins.length===0) throw new Error('没有发现任何可用的数据bin');
    const avail=this.allBins.filter(b=>b.status==='available');
    this.currentBinInfo=avail.length>0?avail[0]:this.allBins[0];
    if(this.currentBinInfo.status!=='available') this.currentBinInfo.status='active';
    return true;
  }
  async checkAndSwitchBin(newSize){
    const usage=this.currentBinInfo.estimatedSize+newSize;
    if(usage<=this.config.maxBinSize*0.9) return false;
    this.allBins=await this.scanAllKnownBins();
    const newBin=this.selectBestAvailableBin(newSize);
    if(newBin.binId===this.currentBinInfo.binId) return false;
    this.currentBinInfo.status='full';
    this.currentBinInfo=newBin; this.currentBinInfo.status='active';
    return true;
  }
  async saveUserSession(sessionData, records){
    const newDataSize = this.getDataSize({sessions:[sessionData], comparisons:records});
    await this.checkAndSwitchBin(newDataSize);
    const current=await this.readDataBin(this.currentBinInfo.binId);
    const existing=current.sessions||[];
    const idx=existing.findIndex(s=>s.sessionId===sessionData.sessionId);
    let updatedSessions;
    if(idx!==-1){
      updatedSessions=[...existing];
      updatedSessions[idx]={...updatedSessions[idx], ...sessionData, lastUpdated:new Date().toISOString()};
    }else{
      updatedSessions=[...existing, sessionData];
    }
    const updatedData = {
      ...current,
      sessions: updatedSessions,
      comparisons: [...(current.comparisons||[]), ...records],
      lastUpdated: new Date().toISOString()
    };
    await this.updateDataBin(this.currentBinInfo.binId, updatedData);
    return true;
  }
  async readAllData(){
    const allSessions=[], allComparisons=[];
    for(const info of this.allBins){
      if(info.status==='error') continue;
      try{
        const d=await this.readDataBin(info.binId);
        if(d.sessions) allSessions.push(...d.sessions);
        if(d.comparisons) allComparisons.push(...d.comparisons);
      }catch(e){}
    }
    return {sessions:allSessions, comparisons:allComparisons, lastUpdated:new Date().toISOString()};
  }
  async clearAllData(){
    let ok=0, bad=0;
    for(const info of this.allBins){
      if(info.status==='error') continue;
      try{
        const empty={sessions:[], comparisons:[], binInfo:{createdAt:info.createdAt, recordCount:0}, lastUpdated:new Date().toISOString()};
        await this.updateDataBin(info.binId, empty);
        ok++;
      }catch(e){ bad++; }
    }
    return ok>0 && bad===0;
  }
}

let multiBinManager = null;
async function initializeMultiBinManager(){
  if(!multiBinManager){
    multiBinManager = new MultiBinManager(MULTI_BIN_CONFIG);
    await multiBinManager.initialize();
  }
  return multiBinManager;
}

/** =========================
 *  UI 多语言（最小）
 *  ========================= */
let currentLanguage = 'zh';
function selectLanguage(lang){
  currentLanguage = lang;
  applyLanguage();
  showPage('surveyPage');
}

function applyLanguage(){
  if(currentLanguage==='zh'){
    document.getElementById('surveyTitle').textContent = '两两对比实验';
    document.getElementById('nicknameLabel').textContent = '您的昵称：';
    document.getElementById('nicknameHint').textContent = '用于识别本次作答。';
    document.getElementById('startButtonText').textContent = '开始实验';

    document.getElementById('progressTitle').textContent = '实验进度';
    document.getElementById('compareHintTitle').textContent = '请选择更优方案';
    document.getElementById('leftBtn').textContent = '左图更优';
    document.getElementById('rightBtn').textContent = '右图更优';

    document.getElementById('countdownLabel').textContent = '请思考';
    document.getElementById('countdownSuffix').textContent = '秒后可选择';

    document.getElementById('finishTitle').textContent = '实验完成';
    document.getElementById('finishText').textContent = '您已完成 8 道对比题，数据已提交。感谢您的参与！';
    document.getElementById('restartButton').textContent = '重新开始';
  }else{
    document.getElementById('surveyTitle').textContent = 'Pairwise Comparison';
    document.getElementById('nicknameLabel').textContent = 'Your nickname:';
    document.getElementById('nicknameHint').textContent = 'Used for this run only.';
    document.getElementById('startButtonText').textContent = 'Start';

    document.getElementById('progressTitle').textContent = 'Progress';
    document.getElementById('compareHintTitle').textContent = 'Choose the better plan';
    document.getElementById('leftBtn').textContent = 'Left is better';
    document.getElementById('rightBtn').textContent = 'Right is better';

    document.getElementById('countdownLabel').textContent = 'Think';
    document.getElementById('countdownSuffix').textContent = 's to unlock';

    document.getElementById('finishTitle').textContent = 'Completed';
    document.getElementById('finishText').textContent = 'You have completed 8 trials. Data saved. Thank you!';
    document.getElementById('restartButton').textContent = 'Restart';
  }
}

/** =========================
 *  页面切换
 *  ========================= */
function showPage(id){
  ['languagePage','surveyPage','comparePage','thankYouPage'].forEach(pid=>{
    document.getElementById(pid).classList.add('hidden');
  });
  const el=document.getElementById(id);
  el.classList.remove('hidden');
  el.classList.add('fade-in');
}

function showDataStatus(message,type='loading'){
  const indicator=document.getElementById('dataStatusIndicator');
  const statusDiv=indicator.querySelector('.status-indicator');
  const textEl=document.getElementById('dataStatusText');
  const spinner=statusDiv.querySelector('.spinner');
  statusDiv.className='status-indicator';
  if(type==='loading'){ statusDiv.classList.add('status-warning'); spinner.style.display='block'; }
  if(type==='success'){ statusDiv.classList.add('status-success'); spinner.style.display='none'; }
  if(type==='error'){ statusDiv.classList.add('status-error'); spinner.style.display='none'; }
  textEl.textContent = message;
  indicator.classList.remove('hidden');
}
function hideDataStatus(){ document.getElementById('dataStatusIndicator').classList.add('hidden'); }

/** =========================
 *  实验：生成题目计划
 *  要求：gen30 两题连在一起；gen60 两题连在一起（同理 gen90/solution 也连在一起）
 *  ========================= */
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function filenameFromUrl(url){
  try{
    const u=url.split('?')[0];
    const parts=u.split('/');
    return parts[parts.length-1] || url;
  }catch(e){ return url; }
}

function buildTrialPlan(){
  const plan = [];

  // 组顺序固定：gen30 -> gen60 -> gen90 -> solution
  for(const g of GROUPS){
    const leftPicked = shuffle(g.left).slice(0, TRIALS_PER_GROUP);
    const rightPicked = shuffle(g.right).slice(0, TRIALS_PER_GROUP);

    for(let k=0;k<TRIALS_PER_GROUP;k++){
      plan.push({
        schemaVersion: SCHEMA_VERSION,
        groupKey: g.key,
        groupTrialIndex: k+1, // 1..2
        leftUrl: leftPicked[k],
        rightUrl: rightPicked[k],
        leftName: filenameFromUrl(leftPicked[k]),
        rightName: filenameFromUrl(rightPicked[k]),
      });
    }
  }

  // 全局题号 1..8
  return plan.map((t,idx)=>({ ...t, trialIndex: idx+1 }));
}

/** =========================
 *  实验：会话与记录（不读取进度）
 *  ========================= */
let userData = { nickname:'' };
let sessionId = null;
let trialPlan = [];
let currentTrialIdx = 0; // 0..7
let recordsBuffer = [];
let lockTimer = null;
let lockRemaining = DECISION_LOCK_SECONDS;
let locked = true;

function generateSessionIdForUser(nickname){
  return `pairwise_${nickname}_${new Date().toISOString().replace(/[:.Z-]/g,'')}`;
}

function setButtonsLocked(isLocked){
  locked = isLocked;
  const lb = document.getElementById('leftBtn');
  const rb = document.getElementById('rightBtn');

  if(isLocked){
    lb.classList.add('btn-disabled');
    rb.classList.add('btn-disabled');
  }else{
    lb.classList.remove('btn-disabled');
    rb.classList.remove('btn-disabled');
  }
}

function updateCountdownUI(){
  document.getElementById('countdownValue').textContent = String(lockRemaining);
  document.getElementById('countdownPill').style.display = locked ? 'inline-flex' : 'none';
  document.getElementById('phaseText').textContent =
    locked
      ? (currentLanguage==='zh' ? '当前阶段：思考中（不可选择）' : 'Phase: thinking (locked)')
      : (currentLanguage==='zh' ? '当前阶段：可选择' : 'Phase: unlocked');
}

function startDecisionLock(){
  // 清理旧定时器
  if(lockTimer) clearInterval(lockTimer);

  lockRemaining = DECISION_LOCK_SECONDS;
  setButtonsLocked(true);
  updateCountdownUI();

  lockTimer = setInterval(()=>{
    lockRemaining -= 1;
    if(lockRemaining <= 0){
      clearInterval(lockTimer);
      lockTimer = null;
      setButtonsLocked(false);
      updateCountdownUI();
      return;
    }
    updateCountdownUI();
  }, 1000);
}

async function startExperiment(){
  const nickname = document.getElementById('nicknameInput').value.trim();
  if(!nickname){
    alert(currentLanguage==='zh' ? '请输入昵称！' : 'Please enter your nickname!');
    return;
  }

  userData = { nickname };
  sessionId = generateSessionIdForUser(nickname);
  trialPlan = buildTrialPlan(); // 不读取进度，直接新建
  currentTrialIdx = 0;
  recordsBuffer = [];

  showDataStatus(currentLanguage==='zh'?'正在连接服务器...':'Connecting...', 'loading');
  try{
    await initializeMultiBinManager();
    multiBinManager.allBins = await multiBinManager.scanAllKnownBins();
    hideDataStatus();
  }catch(e){
    showDataStatus(currentLanguage==='zh'?'连接失败，请检查网络':'Connection failed. Check network.', 'error');
    setTimeout(hideDataStatus, 2000);
    return;
  }

  // 先写入 session（含 trialPlan）
  await saveSessionSnapshot(true);

  renderTrial();
  showPage('comparePage');
}

function getGroupProgress(plan, idx){
  const cur = plan[idx];
  const key = cur?.groupKey;
  const totalInGroup = plan.filter(t=>t.groupKey===key).length; // 2
  const doneInGroup = plan.slice(0, idx).filter(t=>t.groupKey===key).length;
  return { key, doneInGroup, totalInGroup };
}

function updateProgressUI(){
  const done = currentTrialIdx;
  const percent = Math.round((done / TOTAL_TRIALS) * 100);
  document.getElementById('progressText').textContent =
    (currentLanguage==='zh' ? `已完成 ${done} / ${TOTAL_TRIALS}` : `Completed ${done} / ${TOTAL_TRIALS}`);
  document.getElementById('progressFill').style.width = `${percent}%`;

  const gp = getGroupProgress(trialPlan, Math.min(currentTrialIdx, trialPlan.length-1));
  const groupLine = currentLanguage==='zh'
    ? `当前组：${gp.key || '-'}（本组 ${gp.doneInGroup} / ${gp.totalInGroup}）`
    : `Current group: ${gp.key || '-'} (${gp.doneInGroup} / ${gp.totalInGroup})`;
  document.getElementById('groupProgressText').textContent = groupLine;
}

function renderTrial(){
  if(currentTrialIdx >= trialPlan.length){
    document.getElementById('finishNick').textContent =
      (currentLanguage==='zh' ? `用户：${userData.nickname}` : `User: ${userData.nickname}`);
    showPage('thankYouPage');
    return;
  }

  const t = trialPlan[currentTrialIdx];
  document.getElementById('leftImg').src = t.leftUrl;
  document.getElementById('rightImg').src = t.rightUrl;

  document.getElementById('leftName').textContent = t.leftName;
  document.getElementById('rightName').textContent = t.rightName;

  const meta = currentLanguage==='zh'
    ? `题目：${t.trialIndex} / ${TOTAL_TRIALS} ｜ 组别：${t.groupKey}（第 ${t.groupTrialIndex} 题）`
    : `Trial: ${t.trialIndex} / ${TOTAL_TRIALS} | Group: ${t.groupKey} (#${t.groupTrialIndex})`;
  document.getElementById('trialMeta').textContent = meta;

  updateProgressUI();

  // 每题开始：锁定15秒并倒计时
  startDecisionLock();
}

async function choose(choice){
  if(locked) return; // 双保险

  const t = trialPlan[currentTrialIdx];
  const now = new Date().toISOString();

  const rec = {
    schemaVersion: SCHEMA_VERSION,
    sessionId,
    nickname: userData.nickname,
    trialIndex: t.trialIndex,
    groupKey: t.groupKey,
    groupTrialIndex: t.groupTrialIndex,
    leftUrl: t.leftUrl,
    rightUrl: t.rightUrl,
    leftName: t.leftName,
    rightName: t.rightName,
    choice: choice, // 0/1
    lockSeconds: DECISION_LOCK_SECONDS,
    timestamp: now
  };

  recordsBuffer.push(rec);

  showDataStatus(currentLanguage==='zh'?'正在保存...':'Saving...', 'loading');
  const ok = await saveSessionSnapshot(false);
  if(ok){
    showDataStatus(currentLanguage==='zh'?'保存成功':'Saved', 'success');
    setTimeout(hideDataStatus, 600);
  }else{
    showDataStatus(currentLanguage==='zh'?'保存失败，请检查网络':'Save failed. Check network.', 'error');
    setTimeout(hideDataStatus, 2000);
    return;
  }

  recordsBuffer = [];
  currentTrialIdx++;
  renderTrial();
}

async function saveSessionSnapshot(sessionOnly=false){
  try{
    if(!multiBinManager) await initializeMultiBinManager();

    const sessionData = {
      schemaVersion: SCHEMA_VERSION,
      sessionId,
      userData,
      totalTrials: TOTAL_TRIALS,
      timestamp: new Date().toISOString(),
      lastUpdated: new Date().toISOString(),
      trialPlan
    };

    const newRecords = sessionOnly ? [] : recordsBuffer.map(r => ({...r}));

    await multiBinManager.saveUserSession(sessionData, newRecords);
    return true;
  }catch(e){
    console.error(e);
    return false;
  }
}

function restart(){
  userData = { nickname:'' };
  sessionId = null;
  trialPlan = [];
  currentTrialIdx = 0;
  recordsBuffer = [];
  if(lockTimer) clearInterval(lockTimer);
  lockTimer = null;
  locked = true;
  document.getElementById('nicknameInput').value = '';
  showPage('languagePage');
}

/** =========================
 *  管理员面板（只显示 pairwise_v2）
 *  ========================= */
const ENCODED_ADMIN_KEY='VU1TMjAyNXlncw==';
function getAdminPassword(){ return atob(ENCODED_ADMIN_KEY); }

async function showAdminPanel(){
  const p = prompt('请输入管理员密码：');
  if(p===null) return;
  if(p!==getAdminPassword()){
    alert('密码错误！');
    return;
  }
  document.getElementById('adminPanel').classList.remove('hidden');
  await refreshStats();
}
function hideAdminPanel(){ document.getElementById('adminPanel').classList.add('hidden'); }

function updateDatabaseStatus(message,type='loading'){
  const statusDiv=document.getElementById('databaseStatus');
  let html='';
  if(type==='loading'){
    html=`<div class="loading-indicator"><div class="spinner"></div><span>${message}</span></div>`;
  }else if(type==='success'){
    html=`<div class="status-indicator status-success"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>${message}</span></div>`;
  }else{
    html=`<div class="status-indicator status-error"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg><span>${message}</span></div>`;
  }
  statusDiv.innerHTML=html;
}
function disableAdminButtons(disabled){
  document.getElementById('exportButton').disabled=disabled;
  document.getElementById('clearButton').disabled=disabled;
}

function onlyNewRecords(allComparisons){
  return (allComparisons||[]).filter(r =>
    r && r.schemaVersion===SCHEMA_VERSION &&
    (r.choice===0 || r.choice===1) &&
    r.groupKey && r.leftUrl && r.rightUrl
  );
}

async function refreshStats(){
  try{
    updateDatabaseStatus('正在扫描所有已知bin并读取数据...', 'loading');
    disableAdminButtons(true);

    if(!multiBinManager) await initializeMultiBinManager();
    multiBinManager.allBins = await multiBinManager.scanAllKnownBins();
    const data = await multiBinManager.readAllData();

    const recs = onlyNewRecords(data.comparisons);

    const nickSet = new Set(recs.map(r=>r.nickname).filter(Boolean));
    const totalUsers = nickSet.size;
    const totalRecords = recs.length;
    const avg = totalUsers>0 ? (totalRecords/totalUsers).toFixed(2) : '0.00';

    document.getElementById('totalUsers').textContent = totalUsers;
    document.getElementById('totalRecords').textContent = totalRecords;
    document.getElementById('avgPerUser').textContent = `${avg} / 8`;

    renderGroupedTables(recs);
    renderRecentTable(recs);

    updateDatabaseStatus(`连接成功：已加载两两对比数据 ${totalRecords} 条`, 'success');
    disableAdminButtons(false);
  }catch(e){
    console.error(e);
    updateDatabaseStatus(`连接失败：${e.message}`, 'error');
    disableAdminButtons(true);
  }
}

function renderGroupedTables(recs){
  const container = document.getElementById('groupedTables');
  const groupKeys = ['gen30','gen60','gen90','solution'];

  if(!recs.length){
    container.innerHTML = '<div class="text-gray-500">暂无数据（仅显示本次两两对比 pairwise_v2 的记录）</div>';
    return;
  }

  const byGroup = {};
  for(const k of groupKeys) byGroup[k]=[];
  recs.forEach(r=>{
    if(byGroup[r.groupKey]) byGroup[r.groupKey].push(r);
  });

  let html = '';
  for(const k of groupKeys){
    const list = byGroup[k];
    const leftBetter = list.filter(x=>x.choice===0).length;
    const rightBetter = list.filter(x=>x.choice===1).length;

    html += `
      <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
        <div class="px-4 py-3 bg-gray-50 border-b flex flex-col md:flex-row md:items-center md:justify-between gap-2">
          <div class="font-semibold text-gray-800">组：${k}</div>
          <div class="text-sm text-gray-600">总计：${list.length} ｜ 左图更优：${leftBetter} ｜ 右图更优：${rightBetter}</div>
        </div>
        <div class="overflow-auto">
          <table class="w-full text-sm border-collapse">
            <thead>
              <tr class="bg-white">
                <th class="border p-2">昵称</th>
                <th class="border p-2">题号</th>
                <th class="border p-2">组内题号</th>
                <th class="border p-2">左图文件</th>
                <th class="border p-2">右图文件</th>
                <th class="border p-2">选择</th>
                <th class="border p-2">时间</th>
              </tr>
            </thead>
            <tbody>
    `;

    const sorted = [...list].sort((a,b)=> (a.trialIndex||0)-(b.trialIndex||0));
    sorted.forEach(r=>{
      html += `
        <tr>
          <td class="border p-2">${r.nickname||'-'}</td>
          <td class="border p-2 text-center">${r.trialIndex||'-'}</td>
          <td class="border p-2 text-center">${r.groupTrialIndex||'-'}</td>
          <td class="border p-2 text-xs">${r.leftName||'-'}</td>
          <td class="border p-2 text-xs">${r.rightName||'-'}</td>
          <td class="border p-2 text-center font-semibold">${r.choice===0?'左':'右'}</td>
          <td class="border p-2 text-xs">${r.timestamp?new Date(r.timestamp).toLocaleString():'-'}</td>
        </tr>
      `;
    });

    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  container.innerHTML = html;
}

function renderRecentTable(recs){
  const container = document.getElementById('recentTable');
  if(!recs.length){
    container.innerHTML = '<div class="text-gray-500">暂无数据</div>';
    return;
  }
  const recent = [...recs].sort((a,b)=> new Date(b.timestamp||0) - new Date(a.timestamp||0)).slice(0,30);

  let html = `
    <table class="w-full text-sm border-collapse border border-gray-300 bg-white">
      <thead>
        <tr class="bg-gray-100">
          <th class="border p-2">昵称</th>
          <th class="border p-2">组</th>
          <th class="border p-2">题号</th>
          <th class="border p-2">左图</th>
          <th class="border p-2">右图</th>
          <th class="border p-2">选择</th>
          <th class="border p-2">时间</th>
        </tr>
      </thead>
      <tbody>
  `;
  recent.forEach(r=>{
    html += `
      <tr>
        <td class="border p-2">${r.nickname||'-'}</td>
        <td class="border p-2">${r.groupKey||'-'}</td>
        <td class="border p-2 text-center">${r.trialIndex||'-'}</td>
        <td class="border p-2 text-xs">${r.leftName||'-'}</td>
        <td class="border p-2 text-xs">${r.rightName||'-'}</td>
        <td class="border p-2 text-center font-semibold">${r.choice===0?'左':'右'}</td>
        <td class="border p-2 text-xs">${r.timestamp?new Date(r.timestamp).toLocaleString():'-'}</td>
      </tr>
    `;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

async function exportData(){
  try{
    updateDatabaseStatus('正在导出CSV...', 'loading');
    const data = await multiBinManager.readAllData();
    const recs = onlyNewRecords(data.comparisons);

    if(!recs.length){
      alert('没有可导出的数据（仅导出 pairwise_v2 两两对比记录）');
      updateDatabaseStatus('连接成功', 'success');
      return;
    }

    const headers = [
      'schemaVersion','sessionId','nickname',
      'trialIndex','groupKey','groupTrialIndex',
      'leftUrl','rightUrl','choice',
      'leftName','rightName',
      'lockSeconds',
      'timestamp'
    ];
    let csv = headers.join(',') + '\n';

    recs
      .sort((a,b)=> new Date(a.timestamp||0) - new Date(b.timestamp||0))
      .forEach(r=>{
        const row = [
          r.schemaVersion||'',
          r.sessionId||'',
          r.nickname||'',
          r.trialIndex??'',
          r.groupKey||'',
          r.groupTrialIndex??'',
          r.leftUrl?`"${r.leftUrl}"`:'',
          r.rightUrl?`"${r.rightUrl}"`:'',
          r.choice??'',
          r.leftName||'',
          r.rightName||'',
          r.lockSeconds ?? '',
          r.timestamp||''
        ];
        csv += row.join(',') + '\n';
      });

    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.href=url;
    link.download=`pairwise_v2_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    updateDatabaseStatus('导出完成', 'success');
    setTimeout(()=>updateDatabaseStatus('连接成功', 'success'), 1200);
  }catch(e){
    console.error(e);
    updateDatabaseStatus('导出失败', 'error');
    alert('导出失败：' + e.message);
  }
}

async function clearData(){
  if(!confirm('确定要清空所有数据吗？此操作不可恢复！')) return;
  if(!confirm('最后确认：将删除所有已知bin中的实验数据，确定继续吗？')) return;

  try{
    updateDatabaseStatus('正在清空所有已知bin数据...', 'loading');
    if(!multiBinManager) await initializeMultiBinManager();
    await multiBinManager.clearAllData();
    updateDatabaseStatus('所有数据已清空', 'success');
    await refreshStats();
  }catch(e){
    console.error(e);
    updateDatabaseStatus('清空失败', 'error');
    alert('清空失败：' + e.message);
  }
}

/** =========================
 *  初始化
 *  ========================= */
document.addEventListener('DOMContentLoaded', async ()=>{
  applyLanguage();
  try{ await initializeMultiBinManager(); }catch(e){}
});
</script>
</body>
</html>
